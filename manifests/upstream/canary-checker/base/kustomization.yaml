resources:
  - ../helm/generated_templates/canary-checker/templates/serviceaccount.yaml
  - ../helm/generated_templates/canary-checker/templates/clusterrole.yaml
  - ../helm/generated_templates/canary-checker/templates/clusterrolebinding.yaml
  - ../helm/generated_templates/canary-checker/templates/service.yaml
  - ../helm/generated_templates/canary-checker/templates/deployment.yaml
  - ../helm/generated_templates/canary-checker/templates/ingress.yaml
  - ../helm/generated_templates/canary-checker/templates/priorityclass.yaml
  - servicemonitor.yaml

namespace: platform-system

images:
  - name: docker.io/flanksource/canary-checker:latest
    newTag: '{{.canaryChecker.version | default "v0.38.87" }}'

patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: canary-checker
    spec:
      template:
        metadata:
          annotations:
            com.flanksource.infra.logs/processors.0.drop_event.when.contains.message: patching
            com.flanksource.infra.logs/processors.1.drop_event.when.contains.message: "[pod/canary] request completed with 503, expected [200 201 202], retrying"
            com.flanksource.infra.logs/processors.2.drop_event.when.contains.message: Requeue reconciliation
            com.flanksource.infra.logs/processors.3.drop_event.when.contains.message: Successfully Reconciled
            {{ if not (eq .canaryChecker.persistence.storageClassName "local-path") }}
            cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
            {{ end }}
        spec:
          containers:
            - name: canary-checker
              args:
                - operator
                - -v
                - --httpPort
                - "8080"
                - TEMPLATE_MARK
              livenessProbe: null
              readinessProbe: null
              ports:
                - name: metrics
                  containerPort: 8080
      volumeClaimTemplates:
      - metadata:
          name: canarychecker-database
        spec:
          accessModes: ['ReadWriteOnce']
          resources:
            requests:
              storage: '{{ .canaryChecker.persistence.capacity | default "1Gi" }}'
          storageClassName: '{{ .canaryChecker.persistence.storageClassName | default "local-path" }}'
